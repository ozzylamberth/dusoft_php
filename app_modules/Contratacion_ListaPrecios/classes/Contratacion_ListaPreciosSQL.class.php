<?php  /**  * @package IPSOFT-SIIS  * @version $Id: ContratacionProductosClienteSQL.class.php,  * @copyright (C) 2009 IPSOFT - SA (www.ipsoft-sa.com)  * @author Mauricio Adrian Medina Santacruz  */   /**  * Clase : ContratacionProductosSQL  *   *    * @package IPSOFT-SIIS  * @version $Revision: 1.12 $  * @copyright (C) 2009 IPSOFT - SA (www.ipsoft-sa.com)  * @author Mauricio Adrian Medina Santacruz  */   class Contratacion_ListaPreciosSQL extends ConexionBD  {      /*      * Constructor de la clase      */      function Contratacion_ListaPreciosSQL(){}          /**      * Funcion donde se Consulta la Informacion del Proveedor y se realizan los       * filtros de busqueda teniendo en cuenta diferentes  parametros de busqueda      * @param array $filtro vector con los datos del request donde se encuentra el       * parametos de busqueda      * @param array $offset vector con los datos del request donde se encuentra el      * parametos de busqueda      * @return array $datos vector que contiene la informacion consultada del paciente      */      function ObtenerListaPrecios($Formulario,$empresa_id,$offset)      {          //$this->debug=true;                  $sql= "SELECT   * ";        $sql .= "FROM   listas_precios ";        $sql .=" WHERE                          codigo_lista ILIKE '%".$Formulario['codigo_lista']."%'             and       descripcion ILIKE '%".$Formulario['descripcion']."%'	";                if(!$this->ProcesarSqlConteo("SELECT COUNT(*) FROM(".$sql.") AS A",$offset))        return false;        $sql .= " ORDER BY codigo_lista ";        $sql .= "LIMIT ".$this->limit." OFFSET ".$this->offset." ";		        if(!$rst = $this->ConexionBaseDatos($sql))			return false;        $datos = array();        while (!$rst->EOF)        {        $datos[] = $rst->GetRowAssoc($ToUpper = false);        $rst->MoveNext();        }        $rst->Close();        return $datos;      }            /*      * Funcion donde se consulta  informacion completa del  Proveedor.      * @param string $noId cadena con el valor del numero de identificacion      * @param string $tipoId cadena con el valor del tipo de identificacion      * @return array $datos vector con la informacion de los Proveedor       */      function ConsultarListaDetalle($Formulario,$empresa_id,$offset)      {       //$this->debug=true;        $sql .= " SELECT                          fc_descripcion_producto_alterno(codigo_producto) as descripcion,                         codigo_producto,                         resultado,                         porcentaje,                         precio,                         sw_porcentaje,                         valor_inicial ";        $sql .= " from (";                      $sql .= "SELECT                                         inv.codigo_producto,                                        '0' as resultado,                                        '0' as porcentaje,                                        '0' as precio,                                        '0' as sw_porcentaje,                                        inv.costo as valor_inicial ";                                                              $sql .= " FROM                                             inventarios inv,                                        inventarios_productos invp ";                      $sql .= " WHERE                                               inv.empresa_id = '".$empresa_id."'                                     and   inv.codigo_producto NOT IN (                                                                  select codigo_producto                                                                         from                                                                         listas_precios_detalle                                                                         where                                                                         codigo_lista = '".$Formulario['codigo_lista']."'                                                                  )                                      and inv.codigo_producto = invp.codigo_producto                                      and descripcion ILIKE '%".$Formulario['descripcion']."%' ";                      $sql .= " UNION ";                                            $sql .= " SELECT                                         lpd.codigo_producto,                                        '1' as resultado,                                        lpd.porcentaje,                                        lpd.precio,                                        lpd.sw_porcentaje,                                        lpd.valor_inicial ";                      $sql .= " FROM                                           listas_precios_detalle lpd,                                        inventarios_productos invp ";                      $sql .= " WHERE       lpd.codigo_lista = '".$Formulario['codigo_lista']."'                                       and   lpd.empresa_id = '".$empresa_id."'                                      and   lpd.codigo_producto = invp.codigo_producto                                       and   invp.descripcion ILIKE '%".$Formulario['descripcion']."%'                                      ";        $sql .= "       ) as T ";         $sql .= " ORDER BY resultado DESC ";                if(!$this->ProcesarSqlConteo("SELECT COUNT(*) FROM(".$sql.") AS A",$offset))        return false;            $sql .= "LIMIT ".$this->limit." OFFSET ".$this->offset." ";                        if(!$rst = $this->ConexionBaseDatos($sql))        return false;        $datos = array();        while(!$rst->EOF)        {        $datos[] = $rst->GetRowAssoc($ToUpper);        $rst->MoveNext();        }        $rst->Close();        return $datos;      }           function Consultar_ProductoLista($empresa_id,$codigo_producto,$codigo_lista)		{    //$this->debug=true;		$sql = "SELECT                     *                    FROM                     listas_precios_detalle ";      $sql .= " where ";      $sql .= "          empresa_id = '".$empresa_id."' ";      $sql .= "   and    codigo_lista = '".$codigo_lista."' ";      $sql .= "   and    codigo_producto = '".$codigo_producto."' ";      		if(!$rst = $this->ConexionBaseDatos($sql)) 		return false;		$datos = array(); //Definiendo que va a ser un arreglo.		while(!$rst->EOF) //Recorriendo el Vector;		{		$datos[] = $rst->GetRowAssoc($ToUpper = false); //$datos[$rst->fields[0]] antes.		$rst->MoveNext();		}		$rst->Close();		return $datos;		}             /**********************************************************************************		* Insertar una molcula en la base de datos. Datos enviados desde formulario de Moleculas		* 		* @return token		************************************************************************************/				function Insertar_ProductoLista($empresa_id,$codigo_lista,$codigo_producto,$precio,$sw_porcentaje,$porcentaje,$valor_inicial)		{		if($sw_porcentaje=="")       $sw_porcentaje='0';              if($porcentaje=="")       $porcentaje='0';           $sql  = "INSERT INTO listas_precios_detalle (";		$sql .= "       empresa_id, ";		$sql .= "       codigo_lista, ";		$sql .= "       codigo_producto, ";		$sql .= "       precio, ";		$sql .= "       valor_inicial, ";		$sql .= "       sw_porcentaje, ";		$sql .= "       porcentaje ";		$sql .= "          ) ";		$sql .= "VALUES ( ";		$sql .= "        '".$empresa_id."', ";		$sql .= "        '".$codigo_lista."', ";		$sql .= "        '".$codigo_producto."', ";		$sql .= "        ".$precio.", ";		$sql .= "        COALESCE(".$valor_inicial.",0), ";		$sql .= "        '".$sw_porcentaje."', ";		$sql .= "        COALESCE(".$porcentaje.",0) ";		$sql .= "       ); ";					//$this->debug=true;		if(!$rst = $this->ConexionBaseDatos($sql)) 		return false;		else		return true;		$rst->Close();		}        function Modificar_ProductoLista($empresa_id,$codigo_lista,$codigo_producto,$precio,$sw_porcentaje,$porcentaje,$valor_inicial)		{		if($sw_porcentaje=="")       $sw_porcentaje='0';              if($porcentaje=="")       $porcentaje='0';           $sql  = "UPDATE listas_precios_detalle ";		$sql .= "     SET  precio = ".$precio.", ";		$sql .= "          sw_porcentaje = '".$sw_porcentaje."', ";		$sql .= "          porcentaje = ".$porcentaje.", ";		$sql .= "          valor_inicial = ".$valor_inicial." ";		$sql .= "    ";		$sql .= "where ";		$sql .= "           codigo_producto ='".$codigo_producto."' ";		$sql .= "  and      codigo_lista = '".$codigo_lista."' ";		$sql .= "  and      empresa_id = '".$empresa_id."' ";		$sql .= "       ";					//$this->debug=true;		if(!$rst = $this->ConexionBaseDatos($sql)) 		return false;		else		return true;		$rst->Close();		}         /*	*	Funcion de Consulta SQL, que se encarga de buscar los EstadoDocumentos	*	Existentes en el sistema, segun el grupo.	*/		function Eliminar_ProductoLista($empresa_id,$codigo_lista,$codigo_producto,$precio,$sw_porcentaje,$porcentaje,$valor_inicial)		{      //$this->debug=true;      $sql = " delete from listas_precios_detalle ";      $sql .= "where ";      $sql .= "           codigo_producto ='".$codigo_producto."' ";		  $sql .= "  and      codigo_lista = '".$codigo_lista."' ";		  $sql .= "  and      empresa_id = '".$empresa_id."' ";           			//$this->debug=true;		if(!$rst = $this->ConexionBaseDatos($sql)) 		return false;		else		return true;		$rst->Close();		}     	}?>