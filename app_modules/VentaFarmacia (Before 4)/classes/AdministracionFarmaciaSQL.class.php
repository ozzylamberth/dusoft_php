<?php/** * @package IPSOFT-SIIS * @version $Id: AdministracionFarmaciaSQL.class.php,v 1.1 2010/06/03 20:43:44 hugo Exp $Revision: 1.1 $ * @copyright (C) 2009 IPSOFT - SA (www.ipsoft-sa.com) * @author Sandra Viviana Pantoja Torres */IncludeClass('BodegasDocumentos');class AdministracionFarmaciaSQL extends ConexionBD {    /*     * Constructor de la clase     */    function AdministracionFarmaciaSQL() {        $this->debug = false;    }    /**     * Funcion donde se Consultan los Tipos de identificacion     * @return array $datos vector que contiene la informacion de la consulta de los Tipos     * de Identificacion     */    function ObtenerPermisos() {        $sql = "SELECT a.empresa_id, ";        $sql .= "       b.razon_social AS descripcion1, ";        $sql .= "       b.sw_activa, ";        $sql .= "       a.centro_utilidad, ";        $sql .= "       c.descripcion AS descripcion2, ";        $sql .= "       a.usuario_id, ";        $sql .= "       DE.departamento, ";        $sql .= "       DE.descripcion AS descripcion3, ";        $sql .= "       e.bodega,  ";        $sql .= "       e.descripcion AS descripcion4,   ";        $sql .= "       BN.bodegas_doc_id ";        $sql .= "FROM 	userpermisos_venta_farmacia a, ";        $sql .= "       empresas b, ";        $sql .= "       centros_utilidad c, ";        $sql .= "       bodegas e, ";        $sql .= "       bodegas_doc_numeraciones BN, ";        $sql .= "       departamentos DE ";        $sql .= "WHERE  a.usuario_id = " . UserGetUID() . "  ";        $sql .= "AND 	  a.empresa_id = b.empresa_id ";        $sql .= "AND 	  a.empresa_id = c.empresa_id ";        $sql .= "AND 	  a.centro_utilidad = c.centro_utilidad ";        $sql .= "AND 	  c.empresa_id = e.empresa_id ";        $sql .= "AND 	  c.centro_utilidad = e.centro_utilidad  ";        $sql .= "AND 	  a.empresa_id = c.empresa_id ";        $sql .= "AND    b.sw_activa = '1' ";        $sql .= "AND    b.sw_vende = '1' ";        $sql .= "AND    e.empresa_id = BN.empresa_id ";        $sql .= "AND    e.centro_utilidad = BN.centro_utilidad ";        $sql .= "AND    e.departamento = DE.departamento ";        $sql .= "AND    e.bodega = BN.bodega ";        $sql .= "AND    BN.sw_venta_directa = '1' ";        if (!$rst = $this->ConexionBaseDatos($sql))            return false;        $datos = array();        while (!$rst->EOF) {            $datos[$rst->fields[1]][$rst->fields[4]][$rst->fields[7]][$rst->fields[9]] = $rst->GetRowAssoc($ToUpper = false);            $rst->MoveNext();        }        $rst->Close();        return $datos;    }    /*     * Funcion donde se Listan o se lista el producto buscado     * @return array $datos vector que contiene la informacion de la consulta.     */    function BuscaroListarProductoBodega($form, $offset) {        //$this->debug=true;	//se comenta el siguiente codigo por depuracion 12/06/2017 	//autor: andres gonzalez        /* $sql = " SELECT  X.empresa_id,          X.centro_utilidad,          X.codigo_producto,          X.bodega,          TO_CHAR(X.fecha_vencimiento,'MM/DD/YYYY') AS fecha,          X.fecha_vencimiento,          X.lote,          X.existencia_inicial,          X.existencia_actual - COALESCE(TM.cantidad,0) AS existencia_actual,          fc_descripcion_producto(X.codigo_producto) AS descripcion,          p.descripcion_abreviada,          p.codigo_alterno,          p.codigo_barras,          p.cantidad as presentacion,          p.subclase_id,          s.descripcion as molecula,          c.descripcion as laboratorio,          u.unidad_id,          u.abreviatura AS unidad,          I.costo_ultima_compra,          a.existencia,          round(LD.precio) AS precio_venta          FROM    existencias_bodegas_lote_fv X LEFT JOIN          (          SELECT  SUM(DD.cantidad) AS cantidad,          BN.empresa_id,          BN.centro_utilidad,          BN.bodega,          DD.codigo_producto,          DD.lote,          DD.fecha_vencimiento          FROM    tmp_bodegas_documentos TD,          tmp_bodegas_documentos_d DD,          bodegas_doc_numeraciones BN          WHERE   BN.empresa_id = '" . $form['empresa_id'] . "'          AND     BN.bodegas_doc_id = TD.bodegas_doc_id          AND     TD.documento = DD.documento          GROUP BY BN.empresa_id, BN.centro_utilidad, BN.bodega, DD.codigo_producto,DD.lote, DD.fecha_vencimiento          ) TM          ON (          TM.empresa_id = X.empresa_id AND          TM.centro_utilidad = X.centro_utilidad AND          TM.bodega = X.bodega AND          TM.codigo_producto = X.codigo_producto AND          TM.lote = X.lote AND          TM.fecha_vencimiento = X.fecha_vencimiento          ),          existencias_bodegas a ,          inventarios I,          inventarios_productos p,          inv_subclases_inventarios s,          inv_clases_inventarios  c,          unidades u,          listas_precios LP,          listas_precios_detalle LD          WHERE   X.empresa_id=a.empresa_id          AND     X.centro_utilidad= a.centro_utilidad          AND     X.bodega=a.bodega          AND     X.codigo_producto=a.codigo_producto          AND     a.empresa_id=I.empresa_id          AND     a.codigo_producto=I.codigo_producto          AND     I.codigo_producto=p.codigo_producto          AND			p.grupo_id=s.grupo_id          AND 		p.clase_id=s.clase_id          AND 		p.subclase_id=s.subclase_id          AND			s.grupo_id=c.grupo_id          AND 		s.clase_id=c.clase_id          AND 		p.unidad_id=u.unidad_id          AND     a.existencia >0          AND     X.empresa_id = '" . $form['empresa_id'] . "'          AND     X.centro_utilidad = '" . $form['centro_utilidad'] . "'          AND     X.bodega = '" . $form['bodega'] . "'          AND     LP.empresa_id = a.empresa_id          AND     LP.centro_utilidad = a.centro_utilidad          AND     LP.bodega = a.bodega          AND     LP.codigo_lista = LD.codigo_lista          AND     LD.codigo_producto = a.codigo_producto          AND     LP.empresa_id = LD.empresa_id          AND     X.existencia_actual > 0 "; */        $sql = "SELECT  X.empresa_id,                        X.centro_utilidad,                        X.codigo_producto,                        X.bodega,                        TO_CHAR(X.fecha_vencimiento,'MM/DD/YYYY') AS fecha,                        X.fecha_vencimiento,                        X.lote,                        X.existencia_inicial,                        X.existencia_actual - COALESCE(TM.cantidad,0) AS existencia_actual,                        fc_descripcion_producto(X.codigo_producto) AS descripcion,                                                p.descripcion_abreviada,                        p.codigo_alterno,                        p.codigo_barras,                        p.cantidad as presentacion,                        p.subclase_id,                        s.descripcion as molecula,                        c.descripcion as laboratorio,                        u.unidad_id,                        u.abreviatura AS unidad,                        I.costo_ultima_compra,                        a.existencia,                        round(LD.precio) AS precio_venta                        FROM    existencias_bodegas_lote_fv X                        INNER JOIN existencias_bodegas a ON (X.empresa_id=a.empresa_id                                                                        AND     X.centro_utilidad= a.centro_utilidad                                                                        AND     X.bodega=a.bodega                                                                        AND     X.codigo_producto=a.codigo_producto)                        INNER JOIN inventarios I ON (a.empresa_id=I.empresa_id                                                        AND     a.codigo_producto=I.codigo_producto)                        INNER JOIN  inventarios_productos p ON (I.codigo_producto=p.codigo_producto)                        INNER JOIN  inv_subclases_inventarios s ON (p.grupo_id=s.grupo_id                                                                        AND 		p.clase_id=s.clase_id                                                                        AND 		p.subclase_id=s.subclase_id)                        INNER JOIN   inv_clases_inventarios  c ON (s.grupo_id=c.grupo_id                                                                        AND 		s.clase_id=c.clase_id)                        INNER JOIN    unidades u ON (p.unidad_id=u.unidad_id)                        INNER JOIN   listas_precios LP ON (LP.empresa_id = a.empresa_id                                                                AND     LP.centro_utilidad = a.centro_utilidad                                                                AND     LP.bodega = a.bodega)                        INNER JOIN   listas_precios_detalle LD ON (   LP.codigo_lista = LD.codigo_lista                                        AND     LD.codigo_producto = a.codigo_producto                                        AND     LP.empresa_id = LD.empresa_id)                        LEFT JOIN                        (                        SELECT  SUM(DD.cantidad) AS cantidad,                        BN.empresa_id,                        BN.centro_utilidad,                        BN.bodega,                        DD.codigo_producto,                        DD.lote,                        DD.fecha_vencimiento                        FROM    tmp_bodegas_documentos TD,                        tmp_bodegas_documentos_d DD,                        bodegas_doc_numeraciones BN                        WHERE   BN.empresa_id = '" . $form['empresa_id'] . "'                                                AND     BN.bodegas_doc_id = TD.bodegas_doc_id                        AND     TD.documento = DD.documento                        GROUP BY BN.empresa_id, BN.centro_utilidad, BN.bodega, DD.codigo_producto,DD.lote, DD.fecha_vencimiento                        ) TM                        ON (                        TM.empresa_id = X.empresa_id AND                        TM.centro_utilidad = X.centro_utilidad AND                        TM.bodega = X.bodega AND                        TM.codigo_producto = X.codigo_producto AND                        TM.lote = X.lote AND                        TM.fecha_vencimiento = X.fecha_vencimiento            )            WHERE            a.existencia >0            AND  X.existencia_actual > 0	    AND     X.empresa_id = '" . $form['empresa_id'] . "'	    AND     LP.codigo_lista = '". $form['select_listas_precios'] ."'	    AND     X.centro_utilidad = '" . $form['centro_utilidad'] . "'	    AND     X.bodega = '" . $form['bodega'] . "'	    ";        if ($form['codigo_producto'])            $sql .= " AND    p.codigo_producto ILIKE '" . $form['codigo_producto'] . "' ";        if ($form['codigo_alterno'])            $sql .= " AND    p.codigo_alterno ILIKE '" . $form['codigo_alterno'] . "' ";        if ($form['codigo_barras'] != "")            $sql .= " AND     p.codigo_barras  ILIKE '" . $form['codigo_barras'] . "' ";        if ($form['descripcion'] != "")            $sql .= " AND    p.descripcion  ILIKE '%" . $form['descripcion'] . "%' ";        if (!$this->ProcesarSqlConteo("SELECT COUNT(*) from (" . $sql . ") A", $offset, null, 10))            return false;        $sql .= "LIMIT " . $this->limit . " OFFSET " . $this->offset;        if (!$rst = $this->ConexionBaseDatos($sql))            return false;        $datos = array();        while (!$rst->EOF) {            $datos[] = $rst->GetRowAssoc($ToUpper = false);            $rst->MoveNext();        }        $rst->Close();                $GLOBALS['descripcion'] = $datos['descripcion'];        return $datos;    }    /*     * Funcion donde se Consultan el tipo id de la empresa que ha generado el documento de despacho a la farmacia.     * @return array $datos vector que contiene la informacion de la consulta.     */    function ConsultarTipoId() {        $sql = "SELECT    tipo_id_tercero, descripcion ";        $sql .= "FROM      tipo_id_terceros ";        $sql .= "ORDER BY  descripcion ";        if (!$rst = $this->ConexionBaseDatos($sql))            return false;        $datos = array();        while (!$rst->EOF) {            $datos[] = $rst->GetRowAssoc($ToUpper);            $rst->MoveNext();        }        $rst->Close();        return $datos;    }}?>