<?php  /**  * @package IPSOFT-SIIS  * @version $Id: ReporteFacturaSQL.class.php,v 1.1 2010/06/03 20:43:44 hugo Exp $  * @copyright (C) 2005 IPSOFT - SA (www.ipsoft-sEA.com)  * @author Hugo F Manrique  */  /**  * Clase : ReporteFacturaSQL  *  * @package IPSOFT-SIIS  * @version $Revision: 1.1 $  * @copyright (C) 2005 IPSOFT - SA (www.ipsoft-sEA.com)  * @author Hugo F  Manrique  */	class ReporteFacturaSQL extends ConexionBD	{  	/*  	* Constructor de la clase  	*/    function ReporteFacturaSQL(){}    /**		* Funcion donde se obtiene la informacion del detalle de la factura    *    * @param array $prm Arreglo de datos con los filtros    *    * @return mixed		*/    function ObtenerInformacionDetalleFactura($prm)    {      $sql  = "SELECT DD.codigo_producto,";      $sql .= "       round(DD.cantidad) AS cantidad, ";      $sql .= "       round(DD.total_costo)  AS total_costo, ";      $sql .= "       TO_CHAR(DD.fecha_vencimiento,'DD/MM/YYYY') AS fecha_vencimiento, ";      $sql .= "       DD.lote, ";      $sql .= "       IV.descripcion,";      $sql .= "       SI.descripcion AS molecula,";      $sql .= "       CI.descripcion AS laboratorio ";      $sql .= "FROM   facturas_documentos_bodega FD, ";      $sql .= "       bodegas_documentos_d DD,";      $sql .= "       inventarios_productos IV, ";      $sql .= "       inv_subclases_inventarios SI,";      $sql .= "       inv_clases_inventarios CI ";      $sql .= "WHERE  FD.empresa_id = '".$prm['empresa_id']."' ";      $sql .= "AND    FD.prefijo = '".$prm['prefijo']."' ";      $sql .= "AND    FD.factura_fiscal = ".$prm['factura_fiscal']." ";      $sql .= "AND    FD.bodegas_doc_id = DD.bodegas_doc_id ";      $sql .= "AND    FD.bodegas_numeracion = DD.numeracion ";      $sql .= "AND    DD.codigo_producto = IV.codigo_producto ";      $sql .= "AND		IV.grupo_id = SI.grupo_id ";      $sql .= "AND 		IV.clase_id = SI.clase_id ";      $sql .= "AND 		IV.subclase_id = SI.subclase_id ";      $sql .= "AND		SI.grupo_id = CI.grupo_id ";      $sql .= "AND 		SI.clase_id = CI.clase_id ";      $sql .= "ORDER BY laboratorio,molecula, IV.descripcion ";      if(!$rst = $this->ConexionBaseDatos($sql))        return false;      $datos = array();			while(!$rst->EOF)			{  			$datos[] = $rst->GetRowAssoc($ToUpper = false);  			$rst->MoveNext();			}      $rst->Close();			return $datos;    }    /**		* Funcion donde se obtiene la informacion del tercero asociado a la factura    *    * @param array $form Arreglo de datos con los filtros    *    * @return mixed		*/		function ObtenerInformacionTercero($form)		{			$sql  = "SELECT	TE.tercero_id,";			$sql .= " 			TE.tipo_id_tercero,";			$sql .= " 			TE.nombre_tercero,";			$sql .= " 			TE.direccion,";			$sql .= " 			TE.telefono,";			$sql .= " 			TE.celular,";			$sql .= " 			TE.tipo_pais_id,";			$sql .= " 			TE.tipo_dpto_id,";			$sql .= " 			TE.tipo_mpio_id,";      $sql .= "       TM.municipio, ";      $sql .= "       TD.departamento, ";      $sql .= "       TP.pais ";			$sql .= "FROM		terceros TE, ";			$sql .= "				tipo_mpios TM, ";      $sql .= "       tipo_dptos TD, ";      $sql .= "       tipo_pais TP ";			$sql .= "WHERE 	TE.tipo_id_tercero = '".$form['tipo_id_tercero']."' ";			$sql .= "AND		TE.tercero_id = '".$form['tercero_id']."' ";      $sql .= "AND    TE.tipo_pais_id = TM.tipo_pais_id ";			$sql .= "AND    TE.tipo_dpto_id = TM.tipo_dpto_id ";			$sql .= "AND    TE.tipo_mpio_id = TM.tipo_mpio_id ";      $sql .= "AND    TM.tipo_pais_id = TD.tipo_pais_id ";			$sql .= "AND    TM.tipo_dpto_id = TD.tipo_dpto_id ";      $sql .= "AND    TD.tipo_pais_id = TP.tipo_pais_id ";			if(!$rst = $this->ConexionBaseDatos($sql)) return false;			$datos = array();			if(!$rst->EOF)			{				$datos = $rst->GetRowAssoc($ToUpper = false);				$rst->MoveNext();			}			$rst->Close();			return $datos;		}    /**    * Funcion donde se obtiene la informacion de la factura    *    * @param array $prm Arreglo con los datos a filtrar    *    * @return mixed    */    function ObtenerInformacionFacturas($prm)    {        $sqlNuevaReforma = '            SELECT                 DC.texto_nueva_reforma AS texto,                to_timestamp(DC.fecha_nueva_reforma, \'YYYY-MM-DD\') AS fecha,                                to_timestamp(FC.fecha_registro, \'YYYY-MM-DD\') AS fecha_registro            FROM                fac_facturas_contado FC,                 documentos DC,                 empresas EM,  			    tipo_mpios TM,                 tipo_dptos TD            WHERE                FC.empresa_id = \''.$prm["empresa_id"].'\'                AND                FC.prefijo = \''.$prm["prefijo"].'\'                AND                FC.factura_fiscal = \''.$prm["factura_fiscal"].'\'                AND                FC.estado = \'0\'                AND                FC.empresa_id = EM.empresa_id                AND                EM.tipo_pais_id = TM.tipo_pais_id                AND                EM.tipo_dpto_id = TM.tipo_dpto_id                AND                EM.tipo_mpio_id = TM.tipo_mpio_id                AND                TM.tipo_pais_id = TD.tipo_pais_id                AND                TM.tipo_dpto_id = TD.tipo_dpto_id                AND                FC.empresa_id = DC.empresa_id                AND                FC.documento_id = DC.documento_id      ';        if(!$consultaNuevaReforma = $this->ConexionBaseDatos($sqlNuevaReforma)){            return false;        }        $reforma = 'DC.texto1';        $datosNuevaReforma = array();        if(!$consultaNuevaReforma->EOF)        {            $datosNuevaReforma = $consultaNuevaReforma->GetRowAssoc($ToUpper = false);            $consultaNuevaReforma->MoveNext();        }        $consultaNuevaReforma->Close();        if(isset($datosNuevaReforma) && isset($datosNuevaReforma['fecha']) && isset($datosNuevaReforma['texto'])){            $fechaRegistro = date('Y-m-d', strtotime($datosNuevaReforma['fecha_registro']));            $fechaNuevaReforma = date('Y-m-d', strtotime($datosNuevaReforma['fecha']));            $textoNuevaReforma = $datosNuevaReforma['texto'];            if($fechaRegistro >= $fechaNuevaReforma && $textoNuevaReforma != '' && $textoNuevaReforma != 'NULL'){                $reforma = "'".$textoNuevaReforma."' AS texto1";                //print_r('Fecha actual es mayor!! ');            }        }        //print_r($reforma);        //die();        $sql  = "SELECT FC.prefijo,";        $sql .= "       FC.factura_fiscal,";        $sql .= "       FC.total_abono,";        $sql .= "       FC.total_efectivo,";        $sql .= "       FC.total_cheques,";        $sql .= "       FC.total_tarjetas,";        $sql .= "       FC.total_bonos, ";        $sql .= "       FC.tipo_id_tercero,";        $sql .= "       FC.tercero_id,";        $sql .= "       FC.estado,";        $sql .= "       TO_CHAR(FC.fecha_registro,'DD/MM/YYYY') AS fecha_registro,";        $sql .= "       DC.numero_digitos,";        $sql .= "       ".$reforma.",";        $sql .= "       DC.texto2,";        $sql .= "       DC.texto3,"; //Direccion      $sql .= "       DC.mensaje,"; //telefonos      $sql .= "       DC.descripcion, ";      $sql .= "       EM.tipo_id_tercero AS tipo_id_empresa,";      $sql .= " 	    EM.id,";      $sql .= " 	    EM.razon_social, ";      $sql .= " 	    EM.direccion, ";      $sql .= " 	    EM.telefonos, ";      $sql .= "       TM.municipio, ";      $sql .= "       TD.departamento ";      $sql .= "FROM   fac_facturas_contado FC, ";      $sql .= "       documentos DC, ";      $sql .= "       empresas EM, "; 			$sql .= "				tipo_mpios TM, ";      $sql .= "       tipo_dptos TD ";      $sql .= "WHERE  FC.empresa_id = '".$prm['empresa_id']."' ";      $sql .= "AND    FC.prefijo = '".$prm['prefijo']."' ";      $sql .= "AND    FC.factura_fiscal = ".$prm['factura_fiscal']." ";      $sql .= "AND    FC.estado = '0' ";      $sql .= "AND    FC.empresa_id = EM.empresa_id ";      $sql .= "AND    EM.tipo_pais_id = TM.tipo_pais_id ";			$sql .= "AND    EM.tipo_dpto_id = TM.tipo_dpto_id ";			$sql .= "AND    EM.tipo_mpio_id = TM.tipo_mpio_id ";      $sql .= "AND    TM.tipo_pais_id = TD.tipo_pais_id ";			$sql .= "AND    TM.tipo_dpto_id = TD.tipo_dpto_id ";      $sql .= "AND    FC.empresa_id = DC.empresa_id ";      $sql .= "AND    FC.documento_id = DC.documento_id ";      if(!$rst = $this->ConexionBaseDatos($sql))        return false;			$datos = array();			if(!$rst->EOF)			{				$datos = $rst->GetRowAssoc($ToUpper = false);				$rst->MoveNext();			}			$rst->Close();			return $datos;    }	function Get_NombreUser($userId)	{	 $sql  = " SELECT nombre FROM system_usuarios WHERE ";	 $sql .= "               usuario_id = ".$userId;	 if(!$rst = $this->ConexionBaseDatos($sql))	    return false;	 $nom = array();	 while(!$rst->EOF)	 {	  $nom = $rst->GetRowAssoc($Toupper = false);	  $rst->Movenext();	 }	 $rst->Close();	 return $nom;	}    //ADDED 08-2012	/*Consultar si el producto esta marcado con iva*/    function Valida_IvaProd($codigo)    {	 $sql  = "SELECT porc_iva FROM inventarios_productos ";	 $sql .= " WHERE  codigo_producto = '".$codigo."' ";	 if(!$rst = $this->ConexionBaseDatos($sql))	    return false;	 $iva = array();	 while(!$rst->EOF)	 {	  $iva = $rst->GetRowAssoc($Toupper = false);	  $rst->Movenext();	 }	 $rst->Close();	 return $iva;	}    //ADDED 3108-2012	/*Consultar el prefijo de facturacion correspondiente a una farmacia zona salud)*/    function ObtenerPrefijo($empresa,$bodega)    {	 $sql  = "SELECT prefijo FROM documentos ";	 $sql .= " WHERE  empresa_id = '".trim($empresa)."' ";	 $sql .= " AND  bodega = '".trim($bodega)."' ";	 if(!$rst = $this->ConexionBaseDatos($sql))	    return false;	 $pf = array();	  $pf = $rst->GetRowAssoc($Toupper = false);	 return $pf;	}        function ObtenerPrefijos($empresa,$bodega)        {            $sql  = "SELECT prefijo, prefijo2 FROM documentos ";            $sql .= " WHERE  empresa_id = '".trim($empresa)."' ";            $sql .= " AND  bodega = '".trim($bodega)."' ";            if(!$rst = $this->ConexionBaseDatos($sql))                return false;            $pf = array();            $pf = $rst->GetRowAssoc($Toupper = false);            return $pf;        }    //ADDED 3108-2012	/*Verificar la existencia de una factura para reimpresion*/    function VerificarFactura($datos)    {	 $sql  = "SELECT documento_id FROM fac_facturas_contado ";	 $sql .= " WHERE  empresa_id = '".trim($datos['empresa_id'])."' ";	 $sql .= " AND  prefijo = '".trim($datos['prefijo'])."' ";	 $sql .= " AND  factura_fiscal = ".trim($datos['factura_fiscal']);	 //echo "sql: ".$sql;	 if(!$rst = $this->ConexionBaseDatos($sql))	     return false;	 $dc = array();	 $dc = $rst->GetRowAssoc($Toupper = false);	 return $dc;	}  }?>